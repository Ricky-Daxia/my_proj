#include "trading_platform.h"
#include<fstream>
#include<ctime>
#include<conio.h>
#include<iomanip>

void Delay(int   time)//time*1000为秒数 
{ 
    clock_t   now   =   clock(); 

    while(   clock()   -   now   <   time   ); 
} 

inline bool contain_space (string& str) {
    for (int i = 0; i < str.size(); ++i)
        if (str[i] == ' ') return true;
    return false;
}

trading_platform:: trading_platform () { //把用户商品初始化变成类的私有函数然后调用
    user_num = -1, commodity_num = -1, order_num = -1;
    user_list = {}, name_list = {}, commodity_list = {}, order_list = {};
    string buffer = "", temp = "";
    vector<string> attributes = {};
    //初始化用户
    ifstream ifs;
    ofstream ofs;
    ifs.open(USER, ios::in);
    if (!ifs.is_open()){
        ofs.open (USER, ios::out);
        ofs << "用户ID,用户名,密码,联系方式,地址,钱包余额,用户状态" << endl;
        ofs.close();
        user_num = 0;
    }
    else { //读取当前的用户数  
        while (getline(ifs, buffer)) {
            ++user_num;
            if (user_num > 0) {
                for (int i = 0; i < buffer.size(); ++i) { //7个属性存入数组中
                    if (buffer[i] == ',')  {
                        attributes.push_back(temp); 
                        temp = "";
                    }
                    else temp.append(1, buffer[i]);
                }
                //存入
                user_list.push_back(new user(attributes[0], attributes[1], attributes[2], attributes[3], attributes[4], stof(attributes[5]), temp));
                name_list.push_back(attributes[1]);
                temp = "", attributes = {}, buffer = ""; //清空
            }
        }
    }
    ifs.close();

    //初始化商品
    ifs.open (COMMORDITY, ios::in);
    if (!ifs.is_open()) {
        ofs.open (COMMORDITY, ios::out);
        ofs << "商品ID,名称,价格,数量,描述,卖家ID,上架时间,商品状态" << endl;
        ofs.close();
        commodity_num = 0;
    }
    else {
        while (getline(ifs, buffer)) {
            ++commodity_num;
            if (commodity_num > 0) {
                for (int i = 0; i < buffer.size(); ++i) { //7个属性存入数组中
                    if (buffer[i] == ',')  {
                        attributes.push_back(temp); 
                        temp = "";
                    }
                    else temp.append(1, buffer[i]);
                }
            commodity_list.push_back(new commodity(attributes[0], attributes[1], stof(attributes[2]), stoi(attributes[3]), attributes[4], attributes[5], attributes[6], temp));
            temp = "", attributes = {}, buffer = "";
            }
        }
    }
    ifs.close();

    //初始化订单
    ifs.open (ORDER, ios::in);
    if (!ifs.is_open()) {
        ofs.open (ORDER, ios::out);
        ofs << "订单ID,商品ID,交易单价,数量,交易时间,卖家ID,买家ID" << endl;
        ofs.close();
        order_num = 0;
    }
    else {
        while (getline(ifs, buffer)) {
            ++order_num;
            if (order_num > 0) {
                for (int i = 0; i < buffer.size(); ++i) { //7个属性存入数组中
                    if (buffer[i] == ',')  {
                        attributes.push_back(temp); 
                        temp = "";
                    }
                    else temp.append(1, buffer[i]);
                }
            order_list.push_back(new order(attributes[0], attributes[1], stof(attributes[2]), stoi(attributes[3]), attributes[4], attributes[5], temp));
            temp = "", attributes = {}, buffer = "";
            }
        }
    }
    ifs.close();
}

trading_platform:: ~trading_platform () {
    
}

void trading_platform:: show_menu () {
    cout << "============================================" << endl;
    cout << "冬奥纪念品交易平台 为中国奥运健儿加油" << endl;
    cout << "1.管理员登录 2.用户注册 3.用户登录 4.退出程序" << endl;
    cout << "============================================" << endl;
    cout << endl;
}
//1 o
int trading_platform:: admin_login () {
    string input_name;
    string input_password;

    cout << "请输入管理员姓名:";
    cin.sync ();
    getline(cin, input_name);
    cout << "请输入密码:";
    
    char ch;
    while ((ch = getch()) != '\r'){
        input_password.append(1, char(ch)); //不回显
        }

    cout << endl;

    if (input_name == ADMIN_NAME) {
        if (input_password == ADMIN_PASSWORD){
            cout << "-----登录成功!-----" << endl;
            return 1;
        }
        else cout << "密码错误!" << endl;
    }
    else cout << "管理员姓名错误!" << endl;
    return -1;
}

void trading_platform:: save_user () { //保存用户到文件中
    ofstream ofs;
    ofs.open (USER, ios::trunc);
    if (!ofs.is_open()) {
        cout << "Unexpected Error!";
        exit(-1);
    }
    else {
        ofs << "用户ID,用户名,密码,联系方式,地址,钱包余额,用户状态" << endl;
        for (vector<user*>::iterator it = user_list.begin(); it != user_list.end(); ++it)
            ofs << (*it)->UID << ',' << (*it)->user_name << ','
                << (*it)->user_password << ',' << (*it)->contact << ','
                << (*it)->address << ',' << fixed << setprecision(1) <<(*it)->balance << ','
                << (*it)->status << endl;
    }
    ofs.close();
}
//2 o
void trading_platform:: sign_up () { //基本完成检查(不能查中文)
    string user_password = "", contact = "";
    string user_name = "", address = "";
    float balance = 0.0;

    cout << "请输入用户名(不超过10个字符):";
    cin.sync();
    getline (cin, user_name);
    while (user_name.size() > 20 || user_name.size() <= 0 || contain_space (user_name)) {
        cout << "用户名不合法!" << endl << "请重新输入用户名(不超过10个字符):";
        user_name.resize (0);
        cin.sync();
        getline (cin, user_name);
    }
    
    cout << "请输入密码(不超过20个字符,由小写字母和数字组成):";
    char ch;
    while ((ch = getch())){
        if (ch == '\r' || user_password.size() >= 20) break; //输够了就不能再输入了
        else if ((ch >= '0' && ch <= '9') || (ch >= 'a' && ch <= 'z')) {//合法性检查
            user_password.append(1, char(ch)); //注意函数参数
            cout.put('*');
        }
        else {
            cout << endl << "密码中含有不合法字符!" << endl;
            user_password.resize (0);
            cout << "请重新输入密码(不超过20个字符,由小写字母和数字组成):" ;
        }
    }

    cout << endl << "请输入联系方式(不超过20个字符,由数字组成):";
    cin.sync ();
    getline (cin, contact);
    while (contact.size() > 20 || contact.size() <= 0 || !contain_all_nums (contact) || contain_space (contact)) {
        cout << "输入有误!" << endl << "请重新输入联系方式(不超过20个字符,由数字组成):";
        contact.resize (0);
        cin.sync ();
        getline (cin, contact);
    }

    cout << "请输入地址(不超过20个字符,中文汉字或英文字母):";
    cin.sync ();
    getline (cin, address);
    while (address.size() > 20 || contain_space (address)) {
        cout << "输入有误!" << endl << "请重新输入地址(不超过20个字符,中文汉字或英文字母):";
        address.resize (0);
        cin.sync ();
        getline (cin, address);
    }

    if (!name_list.empty()) { //保证用户名唯一
        bool is_only = false;
        while (!is_only){
            is_only = true;
            for (vector<string>::iterator it = name_list.begin(); it != name_list.end(); ++it)
                if (user_name == *it) {
                    cout << "用户名已存在!" << endl << "请重新输入用户名:";
                    getline (cin, user_name);
                    while (user_name.size() > 20 || user_name.size() <= 0) {
                        cout << "用户名不合法!" << endl << "请重新输入用户名:";
                        user_name.resize (0);
                        cin.sync ();
                        getline (cin, user_name);
                    }
                    is_only = false;
                    break;
                }
        }
    } 

    //存入用户列表中
    if (user_list.empty())
        user_list.push_back(new user("U001", user_name, user_password, contact, address, balance, NORMAL));
    else {
        int i = user_list.size();
        string UID;
        if (i > 0 && i < 10) UID = "U00";
        else if (i < 100) UID = "U0";
        else UID = "U";
        
        UID.append(to_string(i + 1));
        user_list.push_back(new user(UID, user_name, user_password, contact, address, balance, NORMAL));
    }
    this->save_user();
    ++user_num;
    cout << "注册成功!" << endl;
}
//3 o
vector<sub_user_info> trading_platform:: user_login () { //用户登录返回UID和余额
    string user_name, user_password;
    
    cout << "请输入用户名:";
    cin.sync();
    getline (cin, user_name);

    cout << "请输入密码:";
    char ch;
    while ((ch = getch()) != '\r'){
        user_password.append(1, char(ch)); //注意函数参数
        cout.put('*');
    }
    cout << endl;

    for (vector<user*>::iterator it = user_list.begin(); it != user_list.end(); ++it) {
        if ((*it)->user_name == user_name && (*it)->status == "正常") {
            if ((*it)->user_password == user_password) {
                cout << "-----登录成功-----" << endl;
                cout << endl;
                return {sub_user_info ((*it)->UID, (*it)->balance)};
            }
            else cout << "-----密码错误-----" << endl << endl;
            return {};
        }
    }
    cout << "-----用户不存在或已被封禁!-----" << endl << endl;
    return {};
}

//void show_admin_menu () {}

void trading_platform:: save_commodity () { //保存商品
    ofstream ofs;
    ofs.open (COMMORDITY, ios::trunc);
    if (!ofs.is_open()) {
        cout << "Unexpected Error!";
        exit(-1);
    }
    else {
        ofs << "商品ID,名称,价格,数量,描述,卖家ID,上架时间,商品状态" << endl;
        for (vector<commodity*>::iterator it = commodity_list.begin(); it != commodity_list.end(); ++it)
            ofs << (*it)->commodity_id << ',' << (*it)->commodity_name << ','
                << fixed << setprecision(1) <<(*it)->price << ',' << setprecision(0) <<(*it)->stock 
                << ',' << (*it)->text << ',' << (*it)->trader_id
                << ',' << (*it)->launch_time << ',' << (*it)->commodity_status << endl;
        ofs.close();
    }
}

//void display_commodity_list (vector<commodity*>& commodity_list) { //展示商品列表}
//4 o
//void search_commodity (vector<commodity*>& commodity_list) { //搜索商品}
//5 o
//int remove_commodity (vector<commodity*>& commodity_list, string UID) {}

//void display_order_list (vector<order*>& order_list) {}

//void display_user_list (vector<user*>& user_list) { //展示用户列表}
//6 o
//int ban_user (vector<user*>& user_list) { //封禁用户}
//7 o
void trading_platform:: admin_menu () {

    int res = 0;
    string choice = "";
    
    while (true) {
        system("cls");
        show_admin_menu ();
        cout << "请输入操作:";
        cin.sync();
        getline (cin, choice);
        while (choice.size() > 1 || choice.size() <= 0 || (choice[0] != '1' && choice[0] != '2' && choice[0] != '3' && choice[0] != '4' && choice[0] != '5' && choice[0] != '6' && choice[0] != '7')) {
            cout << endl << "无效输入!请重新输入选择:";
            cin.clear(); 
            cin.sync();
            getline (cin, choice);
        }
        switch (stoi(choice))
        {
            case 1: //查看所有商品
                display_commodity_list (commodity_list);
                system("pause");
                break;
            case 2: //搜索商品
                search_commodity (commodity_list);
                system("pause");
                break;
            case 3: //下架商品
                res = remove_commodity (commodity_list, "");
                if (res == 1) this->save_commodity();
                system("pause");
                break;
            case 4: //查看所有订单
                display_order_list (order_list);
                system("pause");
                break;
            case 5: //查看所有用户
                display_user_list (user_list);
                system("pause");
                break;
            case 6: {//封禁用户
                res = ban_user (user_list);
                if (res == 1) this->save_user();
                system("pause");
                break;
            }
            case 7: { //注销模块
                cout << "-----确定退出?-----" << endl;
                cout << "-----按'1'确定,按其它键返回-----" << endl;
                // cin >> res;
                // if (!cin || res != 1) 
                //     break;
                // else {
                //     system("cls");
                //     return;
                char c = getch();
                if (c == '1') {
                    system("cls");
                    return;
                }
                else break;
                }
            default:
                break;
            }
            
        }
}

//void display_user_menu () {}

//void display_buyer_menu () {}

//void display_trader_menu () {}
//8 o
//int launch_commodity (vector<commodity*>& commodity_list, string UID) { //卖家发布商品}

//void display_launched_commodity (vector<commodity*>& commodity_list, string UID) { //展示卖家商品列表}
//9 o
//int modify_commodity (vector<commodity*>& commodity_list, string UID) { //卖家修改商品}

//void display_trader_orders (vector<order*>& order_list, string UID) { //展示卖家订单}
//1 o
void trading_platform:: trader_menu (string cur_UID) { //卖家界面
    int res = 0;
    string choice = "";

    while (true) {
        system("cls");
        display_trader_menu ();
        cout << "请输入操作:";
        cin.sync();
        getline (cin, choice);
        while (choice.size() > 1 || (choice[0] != '1' && choice[0] != '2' && choice[0] != '3' && choice[0] != '4' && choice[0] != '5' && choice[0] != '6')) {
            cout << "输入有误!请重新输入:";
            choice.resize(0);
            cin.sync();
            getline (cin, choice);
        }
        system("cls");
        switch (stoi(choice)) {
            case 1:
                res = launch_commodity (commodity_list, cur_UID);
                if (res == 1) this->save_commodity();
                system("pause");
                break;
            case 2:
                display_launched_commodity (commodity_list ,cur_UID);
                system("pause");
                break;
            case 3:
                res = modify_commodity (commodity_list, cur_UID);
                if (res == 1) this->save_commodity();
                system("pause");
                break;
            case 4:
                res = remove_commodity (commodity_list, cur_UID);
                if (res == 1) this->save_commodity();
                system("pause");
                break;
            case 5:
                display_trader_orders (order_list, cur_UID);
                system("pause");
                break;
            case 6:
                return;
            default:
                cout << "无效操作!" << endl;
                break;
        } 
    }
}
//2 o
int trading_platform:: sub_user_menu () {
    display_user_menu ();
    string choice = "";
    cout << "请输入操作:";
    cin.sync();
    getline (cin, choice);
    while (choice.size() > 1 || (choice[0] != '1' && choice[0] != '2' && choice[0] != '3' && choice[0] != '4')) {
        cout << "输入有误!请重新输入:";
        cin.sync();
        choice.resize(0);
        getline (cin, choice);
        }

    return stoi(choice);
}

//void best_selling (vector<commodity*>& commodity_list) {}
//3 o
float purchase_commodity (vector<user*> user_list, string UID, vector<commodity*>& commodity_list, vector<order*>& order_list) {
    float cur_balance = 0;
    for (vector<user*>::iterator it1 = user_list.begin(); it1 != user_list.end(); ++it1)
        if ((*it1)->UID == UID) {
            cur_balance = (*it1)->balance; 
            cout << "请输入商品ID:";
            string search_id;
            cin.sync();
            getline (cin, search_id);
            cout << "请输入数量:";
            int perchase_num;
            cin >> perchase_num;
            while (!cin) {
                    cout << "发生意想不到的错误!请重新输入:";
                    cin.clear();
                    cin.sync();
                    cin >> perchase_num;
                }
            cin.sync();
            cout << "**************************************************" << endl;
            
            for (vector<commodity*>::iterator it = commodity_list.begin(); it != commodity_list.end(); ++it) 
                if ((*it)->commodity_id == search_id && (*it)->commodity_status == COMMODITY_NORMAL) {
                    if ((*it)->stock < perchase_num)
                        cout << "商品库存不足!" << endl;
                    else if (cur_balance < (*it)->price * perchase_num)
                        cout << "余额不足!" << endl;
                    else {
                        cout << "交易提醒!" << endl;
                        //生成交易时间和新的余额
                        time_t now = time (0);
                        tm* ltime = localtime (&now);
                        string trade_date = to_string(ltime->tm_year + 1900) + "-" + to_string(1 + ltime->tm_mon) + 
                            "-" + to_string(ltime->tm_mday);
                        cout << "交易时间: " << trade_date << endl;
                        cout << "交易单价: " << fixed << setprecision(1) <<(*it)->price << endl;
                        cout << "交易数量: " << perchase_num << endl;
                        cout << "交易状态: 交易成功" << endl;
                        float new_balance = cur_balance - (*it)->price * perchase_num;
                        cout << "您的余额: " << fixed << setprecision(1) <<new_balance << endl;
                        //对商品修改
                        int rest = (*it)->stock - perchase_num;
                        (*it)->stock = rest;
                        if (rest == 0) (*it)->commodity_status = COMMODITY_OUT; 
                        //对订单修改
                        string order_id = "T";
                        int order_cur_size = order_list.size();
                        if (order_cur_size < 9) order_id += "00" + to_string(order_cur_size + 1);
                        else if (order_cur_size < 99) order_id += "0" + to_string(order_cur_size + 1);
                        else order_id += to_string(order_cur_size + 1);
                        order_list.push_back(new order(order_id, (*it)->commodity_id, (*it)->price, perchase_num, trade_date, (*it)->trader_id,UID));
                        (*it1)->balance = new_balance;
                        return new_balance;
                    }
                    cout << "**************************************************" << endl;
                    return cur_balance;
                }
            cout << "没有找到该商品!" << endl;
            cout << "**************************************************" << endl;
    }
    return cur_balance;
}
//4 o
//void search_on_sale (vector<commodity*>& commodity_list) {}

//void display_buyer_order (vector<order*> order_list, string UID) {}
//5 o
//void display_details (vector<commodity*> commodity_list) {}
//6 o
void trading_platform:: buyer_menu (string cur_UID, float cur_balance) { //
    int res = 0;
    string choice = "";
    float return_info = 0;

    while (true) {
        system("cls");
        display_buyer_menu ();
        cout << "请输入操作:";
        getline (cin, choice);
        while (!cin || choice.size() <=  0 || choice.size() > 1 || (choice[0] != '1' && choice[0] != '2' && choice[0] != '3' && choice[0] != '4' && choice[0] != '5' && choice[0] != '6')) {
            cout << "发生意想不到的错误!请重新输入:";
            cin.clear();
            cin.sync();
            getline (cin, choice);
        }
        cin.sync();
        system("cls");
        switch (stoi(choice)) {
            case 1:
                best_selling (commodity_list);
                system("pause");
                break;
            case 2:
                return_info = purchase_commodity (user_list, cur_UID, commodity_list, order_list);
                if (return_info != cur_balance) {
                    this->save_user();
                    this->save_commodity();
                    this->save_order();
                }
                system("pause");
                break;
            case 3:
                search_on_sale (commodity_list);
                system("pause");
                break;
            case 4:
                display_buyer_order (order_list, cur_UID);
                system("pause");
                break;
            case 5:
                display_details (commodity_list);
                system("pause");
                break;
            case 6:
                return;
            default:
                cout << "无效操作!" << endl;
                break;
        } 
    }
}

//void user_info_menu () {}

//void show_user_info (vector<user*> user_list, string UID) {}
//7 o
//void modify_user_info (vector<user*> user_list, string UID, vector<string> name_list) {}
//8 o
//void deposit (vector<user*> user_list, string UID) {}
//9 o
void trading_platform:: manage_user_info (string cur_UID) {
    string choice = "";

    while (true) {
        system("cls");
        user_info_menu ();
        cout << "请输入操作: " << endl;
        while (true) {
            getline (cin, choice);
            while (!cin) {
                cout << "发生意想不到的错误!请重新输入:";
                cin.clear();
                cin.sync();
                getline (cin, choice);
            }
            if (choice.size() <= 0 || choice.size() > 1 || (choice[0] != '1' && choice[0] != '2' && choice[0] != '3' && choice[0] != '4'))
                cout << "无效操作!请重新输入: " << endl;
            else break;
        }
        cin.sync();
        system("cls");
        switch (stoi(choice)) {
            case 1:
                show_user_info (user_list, cur_UID);
                system("pause");
                break;
            case 2:
                modify_user_info (user_list, cur_UID, name_list);
                this->save_user();
                system("pause");
                break;
            case 3:
                deposit (user_list, cur_UID);
                this->save_user();
                system("pause");
                break;
            case 4:
                return;
            default: break;
        }
    }
}

void trading_platform:: save_order () {